"""add_vulnerability_tables

Revision ID: a6b7c8d9e0f1
Revises: a0b1c2d3e4f5
Create Date: 2026-02-01 12:00:00.000000

This migration adds tables for Pro+ CVE/USN vulnerability tracking:
- vulnerability: Central CVE database
- package_vulnerability: Maps vulnerabilities to packages by package manager
- host_vulnerability_scan: Stores scan results per host
- host_vulnerability_finding: Individual findings from scans
- vulnerability_ingestion_log: Tracks data ingestion from various sources

This is part of the Phase 3 Security features for Sysmanage Professional+.
"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op
from sqlalchemy import inspect
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = "a6b7c8d9e0f1"
down_revision: Union[str, None] = "a0b1c2d3e4f5"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def _table_exists(table_name: str) -> bool:
    """Check if a table exists in the database."""
    bind = op.get_bind()
    inspector = inspect(bind)
    return table_name in inspector.get_table_names()


def _index_exists(index_name: str, table_name: str) -> bool:
    """Check if an index exists on a table."""
    bind = op.get_bind()
    inspector = inspect(bind)
    indexes = inspector.get_indexes(table_name)
    return any(idx["name"] == index_name for idx in indexes)


def upgrade() -> None:
    """Create vulnerability tracking tables."""
    bind = op.get_bind()
    is_postgresql = bind.dialect.name == "postgresql"

    # Use appropriate UUID type based on dialect
    if is_postgresql:
        uuid_type = postgresql.UUID(as_uuid=True)
        json_type = postgresql.JSON
    else:
        uuid_type = sa.String(36)
        json_type = sa.Text

    # Create vulnerability table (idempotent)
    if not _table_exists("vulnerability"):
        op.create_table(
            "vulnerability",
            sa.Column("id", uuid_type, primary_key=True),
            sa.Column("cve_id", sa.String(20), nullable=False, unique=True, index=True),
            sa.Column("description", sa.Text, nullable=True),
            sa.Column("cvss_score", sa.String(10), nullable=True),
            sa.Column("cvss_version", sa.String(10), nullable=True),
            sa.Column("severity", sa.String(20), nullable=True),
            sa.Column("published_date", sa.DateTime, nullable=True),
            sa.Column("modified_date", sa.DateTime, nullable=True),
            sa.Column("references", json_type, nullable=True),
            sa.Column("affected_systems", json_type, nullable=True),
            sa.Column("created_at", sa.DateTime, nullable=False),
            sa.Column("updated_at", sa.DateTime, nullable=False),
        )

    # Create package_vulnerability table (idempotent)
    if not _table_exists("package_vulnerability"):
        op.create_table(
            "package_vulnerability",
            sa.Column("id", uuid_type, primary_key=True),
            sa.Column("vulnerability_id", uuid_type, sa.ForeignKey("vulnerability.id", ondelete="CASCADE"), nullable=False, index=True),
            sa.Column("package_name", sa.String(255), nullable=False, index=True),
            sa.Column("package_manager", sa.String(50), nullable=False, index=True),
            sa.Column("vulnerable_versions", sa.String(500), nullable=True),
            sa.Column("fixed_version", sa.String(100), nullable=True),
            sa.Column("advisory_ids", json_type, nullable=True),
            sa.Column("source", sa.String(100), nullable=True),
            sa.Column("created_at", sa.DateTime, nullable=False),
            sa.Column("updated_at", sa.DateTime, nullable=False),
        )

    # Create host_vulnerability_scan table (idempotent)
    if not _table_exists("host_vulnerability_scan"):
        op.create_table(
            "host_vulnerability_scan",
            sa.Column("id", uuid_type, primary_key=True),
            sa.Column("host_id", uuid_type, sa.ForeignKey("host.id", ondelete="CASCADE"), nullable=False, index=True),
            sa.Column("scanned_at", sa.DateTime, nullable=False, index=True),
            sa.Column("total_packages", sa.Integer, nullable=False, default=0),
            sa.Column("vulnerable_packages", sa.Integer, nullable=False, default=0),
            sa.Column("total_vulnerabilities", sa.Integer, nullable=False, default=0),
            sa.Column("critical_count", sa.Integer, nullable=False, default=0),
            sa.Column("high_count", sa.Integer, nullable=False, default=0),
            sa.Column("medium_count", sa.Integer, nullable=False, default=0),
            sa.Column("low_count", sa.Integer, nullable=False, default=0),
            sa.Column("risk_score", sa.Integer, nullable=False, default=0),
            sa.Column("risk_level", sa.String(20), nullable=True),
            sa.Column("summary", sa.Text, nullable=True),
            sa.Column("recommendations", json_type, nullable=True),
            sa.Column("scanner_version", sa.String(20), nullable=True),
        )

    # Create host_vulnerability_finding table (idempotent)
    if not _table_exists("host_vulnerability_finding"):
        op.create_table(
            "host_vulnerability_finding",
            sa.Column("id", uuid_type, primary_key=True),
            sa.Column("scan_id", uuid_type, sa.ForeignKey("host_vulnerability_scan.id", ondelete="CASCADE"), nullable=False, index=True),
            sa.Column("vulnerability_id", uuid_type, sa.ForeignKey("vulnerability.id", ondelete="CASCADE"), nullable=False, index=True),
            sa.Column("package_name", sa.String(255), nullable=False),
            sa.Column("installed_version", sa.String(100), nullable=False),
            sa.Column("fixed_version", sa.String(100), nullable=True),
            sa.Column("severity", sa.String(20), nullable=False),
            sa.Column("cvss_score", sa.String(10), nullable=True),
            sa.Column("remediation", sa.Text, nullable=True),
        )

    # Create vulnerability_ingestion_log table (idempotent)
    if not _table_exists("vulnerability_ingestion_log"):
        op.create_table(
            "vulnerability_ingestion_log",
            sa.Column("id", uuid_type, primary_key=True),
            sa.Column("source", sa.String(100), nullable=False, index=True),
            sa.Column("started_at", sa.DateTime, nullable=False),
            sa.Column("completed_at", sa.DateTime, nullable=True),
            sa.Column("status", sa.String(20), nullable=False),
            sa.Column("vulnerabilities_processed", sa.Integer, nullable=True),
            sa.Column("packages_processed", sa.Integer, nullable=True),
            sa.Column("error_message", sa.Text, nullable=True),
            sa.Column("details", json_type, nullable=True),
        )

    # Create indexes for common queries (idempotent)
    if _table_exists("package_vulnerability") and not _index_exists("ix_package_vulnerability_name_manager", "package_vulnerability"):
        op.create_index(
            "ix_package_vulnerability_name_manager",
            "package_vulnerability",
            ["package_name", "package_manager"],
        )
    if _table_exists("vulnerability") and not _index_exists("ix_vulnerability_severity", "vulnerability"):
        op.create_index(
            "ix_vulnerability_severity",
            "vulnerability",
            ["severity"],
        )


def downgrade() -> None:
    """Remove vulnerability tracking tables."""
    # Drop indexes first (idempotent)
    if _table_exists("vulnerability") and _index_exists("ix_vulnerability_severity", "vulnerability"):
        op.drop_index("ix_vulnerability_severity", table_name="vulnerability")
    if _table_exists("package_vulnerability") and _index_exists("ix_package_vulnerability_name_manager", "package_vulnerability"):
        op.drop_index("ix_package_vulnerability_name_manager", table_name="package_vulnerability")

    # Drop tables in reverse dependency order (idempotent)
    if _table_exists("vulnerability_ingestion_log"):
        op.drop_table("vulnerability_ingestion_log")
    if _table_exists("host_vulnerability_finding"):
        op.drop_table("host_vulnerability_finding")
    if _table_exists("host_vulnerability_scan"):
        op.drop_table("host_vulnerability_scan")
    if _table_exists("package_vulnerability"):
        op.drop_table("package_vulnerability")
    if _table_exists("vulnerability"):
        op.drop_table("vulnerability")
