import { useNavigate, useParams } from "react-router-dom";
import React, { useEffect, useState, useCallback, useMemo } from 'react';
import { DataGrid, GridColDef } from '@mui/x-data-grid';
import Box from '@mui/material/Box';
import Typography from '@mui/material/Typography';
import Button from '@mui/material/Button';
import ArrowBackIcon from '@mui/icons-material/ArrowBack';
import RefreshIcon from '@mui/icons-material/Refresh';
import CircularProgress from '@mui/material/CircularProgress';
import { Chip, Stack, Paper } from '@mui/material';
import { useTranslation } from 'react-i18next';

import { VulnerabilityScan, VulnerabilityFinding, getHostVulnerabilityScan, runHostVulnerabilityScan } from '../Services/license';
import { useTablePageSize } from '../hooks/useTablePageSize';
import { useColumnVisibility } from '../Hooks/useColumnVisibility';
import SearchBox from '../Components/SearchBox';
import ColumnVisibilityButton from '../Components/ColumnVisibilityButton';

const VulnerabilityHostDetail = () => {
    const { hostId } = useParams<{ hostId: string }>();
    const [scanData, setScanData] = useState<VulnerabilityScan | null>(null);
    const [filteredData, setFilteredData] = useState<VulnerabilityFinding[]>([]);
    const [loading, setLoading] = useState<boolean>(true);
    const [scanning, setScanning] = useState<boolean>(false);
    const [error, setError] = useState<string | null>(null);
    const [searchTerm, setSearchTerm] = useState<string>('');
    const [searchColumn, setSearchColumn] = useState<string>('cve_id');
    const navigate = useNavigate();
    const { t } = useTranslation();

    // Dynamic table page sizing based on window height
    const { pageSize, pageSizeOptions } = useTablePageSize({
        reservedHeight: 300,
        minRows: 5,
        maxRows: 100,
    });

    // Controlled pagination state
    const [paginationModel, setPaginationModel] = useState({ page: 0, pageSize: 10 });

    // Update pagination when pageSize from hook changes
    useEffect(() => {
        setPaginationModel(prev => ({ ...prev, pageSize }));
    }, [pageSize]);

    // Ensure current page size is always in options
    const safePageSizeOptions = useMemo(() => {
        if (!pageSizeOptions || !Array.isArray(pageSizeOptions)) {
            return [5, 10, 25, 50];
        }

        const currentPageSize = paginationModel?.pageSize || 10;
        if (!pageSizeOptions.includes(currentPageSize)) {
            return [...pageSizeOptions, currentPageSize].sort((a, b) => a - b);
        }
        return pageSizeOptions;
    }, [pageSizeOptions, paginationModel?.pageSize]);

    // Column visibility preferences
    const {
        hiddenColumns,
        setHiddenColumns,
        resetPreferences,
        getColumnVisibilityModel,
    } = useColumnVisibility('vulnerability-detail-grid');

    // Get severity color
    const getSeverityColor = (severity: string): 'error' | 'warning' | 'info' | 'default' => {
        switch (severity.toUpperCase()) {
            case 'CRITICAL':
                return 'error';
            case 'HIGH':
                return 'error';
            case 'MEDIUM':
                return 'warning';
            case 'LOW':
                return 'info';
            default:
                return 'default';
        }
    };

    // Memoize columns
    const columns: GridColDef[] = useMemo(() => [
        {
            field: 'cve_id',
            headerName: t('vulnerabilitiesPage.cveId'),
            width: 160,
        },
        {
            field: 'severity',
            headerName: t('vulnerabilitiesPage.severity'),
            width: 120,
            align: 'center',
            headerAlign: 'center',
            renderCell: (params) => (
                <Chip
                    label={params.value}
                    size="small"
                    color={getSeverityColor(params.value)}
                />
            )
        },
        {
            field: 'package_name',
            headerName: t('vulnerabilitiesPage.packageName'),
            width: 180,
        },
        {
            field: 'installed_version',
            headerName: t('vulnerabilitiesPage.installedVersion'),
            width: 150,
        },
        {
            field: 'fixed_version',
            headerName: t('vulnerabilitiesPage.fixedVersion'),
            width: 150,
            renderCell: (params) => {
                if (!params.value) {
                    return <Typography variant="body2" color="text.secondary">-</Typography>;
                }
                return params.value;
            }
        },
        {
            field: 'description',
            headerName: t('vulnerabilitiesPage.description'),
            flex: 1,
            minWidth: 300,
            renderCell: (params) => (
                <Box sx={{
                    whiteSpace: 'normal',
                    wordWrap: 'break-word',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                    display: '-webkit-box',
                    WebkitLineClamp: 2,
                    WebkitBoxOrient: 'vertical',
                }}>
                    {params.value || '-'}
                </Box>
            )
        }
    ], [t]);

    // Search columns configuration
    const searchColumns = [
        { field: 'cve_id', label: t('vulnerabilitiesPage.cveId') },
        { field: 'package_name', label: t('vulnerabilitiesPage.packageName') },
        { field: 'severity', label: t('vulnerabilitiesPage.severity') },
        { field: 'description', label: t('vulnerabilitiesPage.description') }
    ];

    // Load data
    const loadData = useCallback(async () => {
        if (!hostId) return;

        try {
            setLoading(true);
            setError(null);
            const response = await getHostVulnerabilityScan(hostId);
            setScanData(response);
        } catch (err) {
            console.error('Error loading vulnerability scan:', err);
            setError(t('vulnerabilitiesPage.loadError'));
        } finally {
            setLoading(false);
        }
    }, [hostId, t]);

    // Run new scan
    const handleRunScan = async () => {
        if (!hostId) return;

        try {
            setScanning(true);
            setError(null);
            await runHostVulnerabilityScan(hostId);
            // Reload data after scan
            await loadData();
        } catch (err) {
            console.error('Error running vulnerability scan:', err);
            setError(t('vulnerabilitiesPage.scanError'));
        } finally {
            setScanning(false);
        }
    };

    useEffect(() => {
        if (!localStorage.getItem('bearer_token')) {
            navigate("/login");
            return;
        }
        loadData();
    }, [navigate, loadData]);

    // Search functionality
    const performSearch = useCallback(() => {
        if (!scanData?.vulnerabilities) {
            setFilteredData([]);
            return;
        }

        let filtered = [...scanData.vulnerabilities];

        if (searchTerm.trim()) {
            filtered = filtered.filter(vuln => {
                const fieldValue = vuln[searchColumn as keyof VulnerabilityFinding];
                if (fieldValue === null || fieldValue === undefined) {
                    return false;
                }
                const stringValue = String(fieldValue);
                return stringValue.toLowerCase().includes(searchTerm.toLowerCase());
            });
        }

        setFilteredData(filtered);
    }, [scanData, searchTerm, searchColumn]);

    // Update filtered data when search criteria changes
    useEffect(() => {
        performSearch();
    }, [performSearch]);

    // Memoize column visibility model
    const columnVisibilityModel = useMemo(() => ({
        ...getColumnVisibilityModel(),
    }), [getColumnVisibilityModel]);

    // Get risk level color
    const getRiskLevelColor = (riskLevel: string): 'error' | 'warning' | 'info' | 'success' | 'default' => {
        switch (riskLevel?.toUpperCase()) {
            case 'CRITICAL':
                return 'error';
            case 'HIGH':
                return 'error';
            case 'MEDIUM':
                return 'warning';
            case 'LOW':
                return 'info';
            case 'NONE':
                return 'success';
            default:
                return 'default';
        }
    };

    return (
        <Box sx={{
            display: 'flex',
            flexDirection: 'column',
            height: 'calc(100vh - 120px)',
            gap: 2,
            p: 2
        }}>
            {/* Header with back button */}
            <Stack direction="row" spacing={2} alignItems="center">
                <Button
                    startIcon={<ArrowBackIcon />}
                    onClick={() => navigate('/vulnerabilities')}
                >
                    {t('vulnerabilitiesPage.backToList')}
                </Button>
                <Typography variant="h4" component="h1" sx={{ flexGrow: 1 }}>
                    {t('vulnerabilitiesPage.hostVulnerabilities')}
                </Typography>
                <Button
                    variant="contained"
                    startIcon={scanning ? <CircularProgress size={20} color="inherit" /> : <RefreshIcon />}
                    onClick={handleRunScan}
                    disabled={scanning}
                >
                    {scanning ? t('vulnerabilitiesPage.scanning') : t('vulnerabilitiesPage.runScan')}
                </Button>
            </Stack>

            {/* Error display */}
            {error && (
                <Typography color="error">{error}</Typography>
            )}

            {/* Summary Cards */}
            {scanData && (
                <Paper sx={{ p: 2 }}>
                    <Stack direction="row" spacing={3} flexWrap="wrap" useFlexGap>
                        <Box>
                            <Typography variant="caption" color="text.secondary">
                                {t('vulnerabilitiesPage.lastScanned')}
                            </Typography>
                            <Typography>
                                {scanData.scanned_at
                                    ? new Date(scanData.scanned_at).toLocaleString()
                                    : t('vulnerabilitiesPage.notScanned')
                                }
                            </Typography>
                        </Box>
                        <Box>
                            <Typography variant="caption" color="text.secondary">
                                {t('vulnerabilitiesPage.riskLevel')}
                            </Typography>
                            <Box>
                                <Chip
                                    label={scanData.risk_level || 'NONE'}
                                    size="small"
                                    color={getRiskLevelColor(scanData.risk_level || 'NONE')}
                                />
                            </Box>
                        </Box>
                        <Box>
                            <Typography variant="caption" color="text.secondary">
                                {t('vulnerabilitiesPage.critical')}
                            </Typography>
                            <Box>
                                <Chip label={scanData.critical_count || 0} size="small" color={scanData.critical_count ? 'error' : 'default'} />
                            </Box>
                        </Box>
                        <Box>
                            <Typography variant="caption" color="text.secondary">
                                {t('vulnerabilitiesPage.high')}
                            </Typography>
                            <Box>
                                <Chip label={scanData.high_count || 0} size="small" color={scanData.high_count ? 'error' : 'default'} />
                            </Box>
                        </Box>
                        <Box>
                            <Typography variant="caption" color="text.secondary">
                                {t('vulnerabilitiesPage.medium')}
                            </Typography>
                            <Box>
                                <Chip label={scanData.medium_count || 0} size="small" color={scanData.medium_count ? 'warning' : 'default'} />
                            </Box>
                        </Box>
                        <Box>
                            <Typography variant="caption" color="text.secondary">
                                {t('vulnerabilitiesPage.low')}
                            </Typography>
                            <Box>
                                <Chip label={scanData.low_count || 0} size="small" color={scanData.low_count ? 'info' : 'default'} />
                            </Box>
                        </Box>
                    </Stack>
                </Paper>
            )}

            {/* Search Controls */}
            <Box sx={{
                p: 2,
                bgcolor: 'background.paper',
                borderRadius: 1,
                boxShadow: 1,
                display: 'flex',
                alignItems: 'center',
                gap: 3,
                flexWrap: 'wrap',
                flexShrink: 0
            }}>
                <SearchBox
                    searchTerm={searchTerm}
                    setSearchTerm={setSearchTerm}
                    searchColumn={searchColumn}
                    setSearchColumn={setSearchColumn}
                    columns={searchColumns}
                    placeholder={t('vulnerabilitiesPage.searchPlaceholder')}
                    inline={true}
                />

                <Box sx={{ flexGrow: 1 }} />

                <ColumnVisibilityButton
                    columns={columns
                        .map(col => ({ field: col.field, headerName: col.headerName || col.field }))}
                    hiddenColumns={hiddenColumns}
                    onColumnsChange={setHiddenColumns}
                    onReset={resetPreferences}
                />
            </Box>

            {/* DataGrid */}
            <Box sx={{ flexGrow: 1, minHeight: 0 }}>
                {filteredData.length === 0 && !loading ? (
                    <Box sx={{
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        height: '100%',
                        bgcolor: 'background.paper',
                        borderRadius: 1
                    }}>
                        <Typography color="text.secondary">
                            {t('vulnerabilitiesPage.noVulnerabilities')}
                        </Typography>
                    </Box>
                ) : (
                    <DataGrid
                        rows={filteredData || []}
                        columns={columns || []}
                        loading={loading}
                        getRowId={(row) => row.id || `${row.cve_id}-${row.package_name}-${Math.random()}`}
                        paginationModel={paginationModel || { page: 0, pageSize: 10 }}
                        onPaginationModelChange={setPaginationModel}
                        initialState={{
                            sorting: {
                                sortModel: [{ field: 'severity', sort: 'asc' }],
                            },
                        }}
                        columnVisibilityModel={columnVisibilityModel}
                        pageSizeOptions={safePageSizeOptions}
                        getRowHeight={() => 'auto'}
                        sx={{
                            '& .MuiDataGrid-cell': {
                                py: 1,
                            },
                        }}
                        localeText={{
                            MuiTablePagination: {
                                labelRowsPerPage: t('common.rowsPerPage'),
                                labelDisplayedRows: ({ from, to, count }: { from: number, to: number, count: number }) => {
                                    const countDisplay = count === -1 ? `${t('common.of')} ${to}` : count;
                                    return `${from}â€“${to} ${t('common.of')} ${countDisplay}`;
                                },
                            },
                            noRowsLabel: t('vulnerabilitiesPage.noVulnerabilities'),
                            noResultsOverlayLabel: t('vulnerabilitiesPage.noVulnerabilities'),
                        }}
                    />
                )}
            </Box>
        </Box>
    );
};

export default VulnerabilityHostDetail;
