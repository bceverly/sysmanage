"""
CVE Data Fetchers - Thin Wrapper.

This is a thin wrapper that delegates to the vuln_engine Cython module.
CVE fetching requires a Pro+ license with the vuln_engine module.
"""

from typing import Any, Dict, Optional

from backend.licensing.features import ModuleCode
from backend.licensing.license_service import license_service
from backend.licensing.module_loader import module_loader
from backend.utils.verbosity_logger import get_logger

from .cve_sources import CVE_SOURCES, CveRefreshError

logger = get_logger("backend.vulnerability.cve_fetchers")

# Re-export for backwards compatibility
__all__ = ["SeverityConverter", "CveFetchers", "CVE_SOURCES", "CveRefreshError"]


def _get_module():
    """Get the vuln_engine module or None."""
    if not license_service.has_module(ModuleCode.VULN_ENGINE):
        return None
    return module_loader.get_module("vuln_engine")


class SeverityConverter:
    """
    Helper methods for converting severity scores/priorities.
    Delegates to vuln_engine module.
    """

    @staticmethod
    def cvss2_to_severity(score: float) -> str:
        """Convert CVSS v2 score to severity string."""
        vuln_engine = _get_module()
        if vuln_engine and hasattr(vuln_engine, "SeverityConverter"):
            return vuln_engine.SeverityConverter.cvss2_to_severity(score)
        raise CveRefreshError("vuln_engine module required for severity conversion")

    @staticmethod
    def cvss3_to_severity(score: float) -> str:
        """Convert CVSS v3.x score to severity string."""
        vuln_engine = _get_module()
        if vuln_engine and hasattr(vuln_engine, "SeverityConverter"):
            return vuln_engine.SeverityConverter.cvss3_to_severity(score)
        raise CveRefreshError("vuln_engine module required for severity conversion")

    @staticmethod
    def ubuntu_priority_to_severity(priority: str) -> str:
        """Convert Ubuntu priority to severity string."""
        vuln_engine = _get_module()
        if vuln_engine and hasattr(vuln_engine, "SeverityConverter"):
            return vuln_engine.SeverityConverter.ubuntu_priority_to_severity(priority)
        raise CveRefreshError("vuln_engine module required for severity conversion")

    @staticmethod
    def debian_urgency_to_severity(urgency: str) -> str:
        """Convert Debian urgency to severity string."""
        vuln_engine = _get_module()
        if vuln_engine and hasattr(vuln_engine, "SeverityConverter"):
            return vuln_engine.SeverityConverter.debian_urgency_to_severity(urgency)
        raise CveRefreshError("vuln_engine module required for severity conversion")


class CveFetchers(SeverityConverter):
    """
    Mixin class providing CVE fetching methods for various data sources.
    Delegates to vuln_engine module.
    """

    async def fetch_nvd_data(self, db, api_key: Optional[str] = None) -> Dict[str, Any]:
        """Fetch CVE data from NVD."""
        vuln_engine = _get_module()
        if vuln_engine and hasattr(vuln_engine, "_cve_refresh_service"):
            from backend.persistence import models

            return await vuln_engine._cve_refresh_service.fetch_nvd_data(
                db, models, logger, api_key
            )
        raise CveRefreshError("vuln_engine module required for CVE fetching")

    async def fetch_ubuntu_data(self, db) -> Dict[str, Any]:
        """Fetch CVE data from Ubuntu Security API."""
        vuln_engine = _get_module()
        if vuln_engine and hasattr(vuln_engine, "_cve_refresh_service"):
            from backend.persistence import models

            return await vuln_engine._cve_refresh_service.fetch_ubuntu_data(
                db, models, logger
            )
        raise CveRefreshError("vuln_engine module required for CVE fetching")

    async def fetch_debian_data(self, db) -> Dict[str, Any]:
        """Fetch CVE data from Debian Security Tracker."""
        vuln_engine = _get_module()
        if vuln_engine and hasattr(vuln_engine, "_cve_refresh_service"):
            from backend.persistence import db as db_module
            from backend.persistence import models

            return await vuln_engine._cve_refresh_service.fetch_debian_data(
                db, models, logger, db_module.get_engine()
            )
        raise CveRefreshError("vuln_engine module required for CVE fetching")

    async def fetch_redhat_data(self, db) -> Dict[str, Any]:
        """Fetch CVE data from Red Hat Security Data API."""
        vuln_engine = _get_module()
        if vuln_engine and hasattr(vuln_engine, "_cve_refresh_service"):
            from backend.persistence import models

            return await vuln_engine._cve_refresh_service.fetch_redhat_data(
                db, models, logger
            )
        raise CveRefreshError("vuln_engine module required for CVE fetching")

    async def fetch_microsoft_data(self, db) -> Dict[str, Any]:
        """Fetch CVE data from Microsoft Security Response Center."""
        vuln_engine = _get_module()
        if vuln_engine and hasattr(vuln_engine, "_cve_refresh_service"):
            from backend.persistence import models

            return await vuln_engine._cve_refresh_service.fetch_microsoft_data(
                db, models, logger
            )
        raise CveRefreshError("vuln_engine module required for CVE fetching")

    def fetch_freebsd_data(self, db) -> Dict[str, Any]:
        """Fetch CVE data from FreeBSD VuXML."""
        vuln_engine = _get_module()
        if vuln_engine and hasattr(vuln_engine, "_cve_refresh_service"):
            from backend.persistence import models

            return vuln_engine._cve_refresh_service.fetch_freebsd_data(
                db, models, logger
            )
        raise CveRefreshError("vuln_engine module required for CVE fetching")
