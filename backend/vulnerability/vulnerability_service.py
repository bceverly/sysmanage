"""
Vulnerability scanning service for Pro+ hosts.

This is a thin wrapper that delegates to the vuln_engine Cython module.
Vulnerability scanning requires a Pro+ license with the vuln_engine module.
"""

from typing import Any, Dict, List, Optional

from backend.licensing.features import ModuleCode
from backend.licensing.license_service import license_service
from backend.licensing.module_loader import module_loader
from backend.persistence import db as db_module
from backend.persistence import models
from backend.utils.verbosity_logger import get_logger

logger = get_logger("backend.vulnerability.vulnerability_service")


class VulnerabilityServiceError(Exception):
    """Exception raised when vulnerability operations fail."""


class VulnerabilityService:
    """
    Thin wrapper service for vulnerability scanning.
    Delegates to vuln_engine module.
    """

    def _get_module(self):
        """Get the vuln_engine module or raise an error."""
        if not license_service.has_module(ModuleCode.VULN_ENGINE):
            raise VulnerabilityServiceError(
                "Vulnerability scanning requires Pro+ license with vuln_engine module"
            )

        vuln_engine = module_loader.get_module("vuln_engine")
        if vuln_engine is None:
            raise VulnerabilityServiceError("vuln_engine module is not loaded")

        return vuln_engine

    def _get_db_session(self):
        """Get a database session."""
        from sqlalchemy.orm import sessionmaker

        session_local = sessionmaker(
            autocommit=False, autoflush=False, bind=db_module.get_engine()
        )
        return session_local()

    def scan_host(self, host_id: str) -> Dict[str, Any]:
        """
        Perform vulnerability scan on a host.

        Args:
            host_id: The host ID to scan

        Returns:
            Dictionary with scan results
        """
        vuln_engine = self._get_module()
        with self._get_db_session() as db:
            return vuln_engine._vulnerability_service.scan_host(host_id, db, models)

    def get_latest_scan(self, host_id: str) -> Optional[Dict[str, Any]]:
        """
        Get the most recent vulnerability scan for a host.

        Args:
            host_id: The host ID

        Returns:
            Dictionary with scan results, or None if no scan exists
        """
        vuln_engine = self._get_module()
        with self._get_db_session() as db:
            return vuln_engine._vulnerability_service.get_latest_scan(
                host_id, db, models
            )

    def get_scan_history(self, host_id: str, limit: int = 10) -> List[Dict[str, Any]]:
        """
        Get vulnerability scan history for a host.

        Args:
            host_id: The host ID
            limit: Maximum number of records to return

        Returns:
            List of scan results
        """
        vuln_engine = self._get_module()
        with self._get_db_session() as db:
            return vuln_engine._vulnerability_service.get_scan_history(
                host_id, limit, db, models
            )

    def get_hosts_with_vulnerabilities(self) -> List[Dict[str, Any]]:
        """
        Get all hosts with their latest vulnerability scan results.

        Returns:
            List of hosts with vulnerability counts by severity
        """
        vuln_engine = self._get_module()
        with self._get_db_session() as db:
            return vuln_engine._vulnerability_service.get_hosts_with_vulnerabilities(
                db, models
            )

    def get_enterprise_summary(self) -> Dict[str, Any]:
        """
        Get enterprise-wide vulnerability summary.

        Returns:
            Dictionary with enterprise-wide vulnerability metrics
        """
        vuln_engine = self._get_module()
        with self._get_db_session() as db:
            return vuln_engine._vulnerability_service.get_enterprise_summary_data(
                db, models
            )


# Global vulnerability service instance
vulnerability_service = VulnerabilityService()
