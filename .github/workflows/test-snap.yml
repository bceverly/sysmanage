name: Test Snap Build

on:
  workflow_dispatch:

jobs:
  build-snap:
    name: Build Snap Package
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Generate requirements-prod.txt
        run: |
          python3 scripts/update-requirements-prod.py

      - name: Build snap with snapcraft
        uses: snapcore/action-build@v1
        id: build_snap
        with:
          path: installer/snap

      - name: List built snap
        run: |
          ls -lh installer/snap/*.snap

      - name: Get snap filename
        id: snap_file
        run: |
          SNAP_FILE=$(ls installer/snap/*.snap | head -1)
          echo "snap_file=$SNAP_FILE" >> $GITHUB_OUTPUT
          echo "Built snap: $SNAP_FILE"

      - name: Upload snap artifact
        uses: actions/upload-artifact@v4
        with:
          name: sysmanage-snap
          path: 'installer/snap/*.snap'
          retention-days: 7

      - name: Test snap installation
        run: |
          SNAP_FILE="${{ steps.snap_file.outputs.snap_file }}"
          echo "Testing installation of $SNAP_FILE"
          sudo snap install --dangerous $SNAP_FILE

          # Verify snap is installed
          snap list sysmanage

          # Check snap info
          snap info sysmanage

          # Verify confinement is strict
          if ! snap info sysmanage | grep -q "confinement:.*strict"; then
            echo "ERROR: Snap is not using strict confinement!"
            exit 1
          fi
          echo "âœ“ Snap is using strict confinement"

      - name: Cleanup
        if: always()
        run: |
          sudo snap remove sysmanage || true
