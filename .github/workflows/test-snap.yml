name: Test Snap Build

on:
  workflow_dispatch:

jobs:
  build-snap:
    name: Build Snap Package
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Generate requirements-prod.txt
        run: |
          python3 scripts/update-requirements-prod.py

      - name: Copy snapcraft.yaml to root
        run: |
          cp installer/snap/snapcraft.yaml .

      - name: Build snap with snapcraft
        uses: snapcore/action-build@v1
        id: build_snap
        with:
          snapcraft-channel: latest/edge

      - name: List built snap
        run: |
          ls -lh *.snap

      - name: Get snap filename
        id: snap_file
        run: |
          SNAP_FILE=$(ls *.snap | head -1)
          echo "snap_file=$SNAP_FILE" >> $GITHUB_OUTPUT
          echo "Built snap: $SNAP_FILE"

      - name: Upload snap artifact
        uses: actions/upload-artifact@v5
        with:
          name: sysmanage-snap
          path: '*.snap'
          retention-days: 7

      - name: Test snap installation
        run: |
          SNAP_FILE="${{ steps.snap_file.outputs.snap_file }}"
          echo "Testing installation of $SNAP_FILE"
          sudo snap install --dangerous $SNAP_FILE

          # Verify snap is installed
          snap list sysmanage

          # Check snap info (both local and installed)
          echo "=== Snap info from store ==="
          snap info sysmanage || true

          echo "=== Snap list with verbose ==="
          snap list --all sysmanage

          # Verify confinement is strict by checking the snap file metadata
          echo "=== Checking snap file metadata ==="
          unsquashfs -l "$SNAP_FILE" | grep -E "meta/(snap.yaml|gui)" | head -5 || true
          unsquashfs -cat "$SNAP_FILE" meta/snap.yaml | grep -E "^(name|confinement):" || true

          # Check confinement from the yaml
          CONFINEMENT=$(unsquashfs -cat "$SNAP_FILE" meta/snap.yaml | grep "^confinement:" | awk '{print $2}')
          echo "Detected confinement: $CONFINEMENT"

          if [ "$CONFINEMENT" != "strict" ]; then
            echo "ERROR: Snap is not using strict confinement! Found: $CONFINEMENT"
            exit 1
          fi
          echo "âœ“ Snap is using strict confinement"

      - name: Cleanup
        if: always()
        run: |
          sudo snap remove sysmanage || true
